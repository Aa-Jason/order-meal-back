{"remainingRequest":"D:\\work\\workspace\\order\\xboot-plus-front\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\work\\workspace\\order\\xboot-plus-front\\src\\views\\login-qr.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\work\\workspace\\order\\xboot-plus-front\\src\\views\\login-qr.vue","mtime":1651629755161},{"path":"D:\\work\\workspace\\order\\xboot-plus-front\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1651770036753},{"path":"D:\\work\\workspace\\order\\xboot-plus-front\\node_modules\\babel-loader\\lib\\index.js","mtime":1651770037115},{"path":"D:\\work\\workspace\\order\\xboot-plus-front\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1651770036753},{"path":"D:\\work\\workspace\\order\\xboot-plus-front\\node_modules\\vue-loader\\lib\\index.js","mtime":1651770027133}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ly8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KDQppbXBvcnQgew0KICBnZXRMb2dpblFSQ29kZSwNCiAgY2hlY2tRUlN0YXR1cywNCiAgdXNlckluZm8sDQogIGdldE90aGVyU2V0LA0KfSBmcm9tICJAL2FwaS9pbmRleCI7DQoNCmltcG9ydCBIZWFkZXIgZnJvbSAiQC92aWV3cy9tYWluLWNvbXBvbmVudHMvaGVhZGVyIjsNCmltcG9ydCBGb290ZXIgZnJvbSAiQC92aWV3cy9tYWluLWNvbXBvbmVudHMvZm9vdGVyIjsNCmltcG9ydCBMYW5nU3dpdGNoIGZyb20gIkAvdmlld3MvbWFpbi1jb21wb25lbnRzL2xhbmctc3dpdGNoIjsNCg0KaW1wb3J0IHV0aWwgZnJvbSAiQC9saWJzL3V0aWwuanMiOw0KaW1wb3J0IFFSQ29kZSBmcm9tICJxcmNvZGUiOw0KaW1wb3J0IENvb2tpZXMgZnJvbSAnanMtY29va2llJzsNCmV4cG9ydCBkZWZhdWx0IHsNCiAgY29tcG9uZW50czogew0KICAgIExhbmdTd2l0Y2gsDQogICAgSGVhZGVyLA0KICAgIEZvb3RlciwNCiAgfSwNCiAgZGF0YSgpIHsNCiAgICByZXR1cm4gew0KICAgICAgbG9hZGluZzogZmFsc2UsDQogICAgICBjaGVja1Rva2VuOiAiIiwNCiAgICAgIC8vIOS6jOe7tOeggeeKtuaAgSDliJ3lp4vkuLowDQogICAgICBxclN0YXR1czogIjAiLA0KICAgICAgcXJVcmw6ICIiLA0KICAgICAgY2hlY2tJbnRlcnZhbDogbnVsbCwNCiAgICB9Ow0KICB9LA0KICBtZXRob2RzOiB7DQogICAgaW5pdCgpIHsNCiAgICAgIHRoaXMuZ2V0UVJDb2RlKCk7DQogICAgfSwNCiAgICBnZXRRUkNvZGUoKSB7DQogICAgICBnZXRMb2dpblFSQ29kZSgpLnRoZW4oKHJlcykgPT4gew0KICAgICAgICBpZiAocmVzLnN1Y2Nlc3MpIHsNCiAgICAgICAgICB0aGlzLnFyU3RhdHVzID0gIjAiOw0KICAgICAgICAgIGxldCB1cmwgPSByZXMucmVzdWx0Ow0KICAgICAgICAgIHRoaXMuZ2VuZXJhdGVRUih1cmwpOw0KICAgICAgICAgIHRoaXMuY2hlY2tUb2tlbiA9IHVybC5zdWJzdHJpbmcodXJsLmluZGV4T2YoIj0iKSArIDEsIHVybC5sZW5ndGgpOw0KICAgICAgICAgIHRoaXMuY2hlY2tMb2dpblFSU3RhdHVzKCk7DQogICAgICAgIH0NCiAgICAgIH0pOw0KICAgIH0sDQogICAgZ2VuZXJhdGVRUih2KSB7DQogICAgICBRUkNvZGUudG9EYXRhVVJMKA0KICAgICAgICB2LA0KICAgICAgICB7DQogICAgICAgICAgbWFyZ2luOiAwLA0KICAgICAgICB9LA0KICAgICAgICAoZXJyLCB1cmwpID0+IHsNCiAgICAgICAgICBpZiAoZXJyKSB7DQogICAgICAgICAgICB0aGlzLiRNZXNzYWdlLmVycm9yKCLnlJ/miJDkuoznu7TnoIHlm77niYflpLHotKUiKTsNCiAgICAgICAgICB9DQoNCiAgICAgICAgICB0aGlzLnFyVXJsID0gdXJsOw0KICAgICAgICB9DQogICAgICApOw0KICAgIH0sDQogICAgY2hlY2tMb2dpblFSU3RhdHVzKCkgew0KICAgICAgLy8gM+enkuajgOa1i+S4gOasoeS6jOe7tOeggeeKtuaAgQ0KICAgICAgaWYgKHRoaXMuY2hlY2tJbnRlcnZhbCkgew0KICAgICAgICBjbGVhckludGVydmFsKHRoaXMuY2hlY2tJbnRlcnZhbCk7DQogICAgICB9DQogICAgICB0aGlzLmNoZWNrSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB7DQogICAgICAgIGNoZWNrUVJTdGF0dXModGhpcy5jaGVja1Rva2VuKS50aGVuKChyZXMpID0+IHsNCiAgICAgICAgICBpZiAocmVzLnN1Y2Nlc3MpIHsNCiAgICAgICAgICAgIHRoaXMucXJTdGF0dXMgPSByZXMucmVzdWx0LnN0YXR1czsNCiAgICAgICAgICAgIGlmICh0aGlzLnFyU3RhdHVzIDwgIjAiKSB7DQogICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5jaGVja0ludGVydmFsKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmICh0aGlzLnFyU3RhdHVzID09ICIyIikgew0KICAgICAgICAgICAgICBsZXQgYWNjZXNzVG9rZW4gPSByZXMucmVzdWx0LmFjY2Vzc1Rva2VuOw0KICAgICAgICAgICAgICB0aGlzLiRNZXNzYWdlLnN1Y2Nlc3MoIuaJq+eggeeZu+W9leaIkOWKnyIpOw0KICAgICAgICAgICAgICB0aGlzLnNldFN0b3JlKCJhY2Nlc3NUb2tlbiIsIGFjY2Vzc1Rva2VuKTsNCiAgICAgICAgICAgICAgdGhpcy5hZnRlckxvZ2luKGFjY2Vzc1Rva2VuKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgICAgfSwgMzAwMCk7DQogICAgfSwNCiAgICBhZnRlckxvZ2luKGFjY2Vzc1Rva2VuKSB7DQogICAgICBnZXRPdGhlclNldCgpLnRoZW4oKHJlcykgPT4gew0KICAgICAgICBpZiAocmVzLnJlc3VsdCkgew0KICAgICAgICAgIGxldCBkb21haW4gPSByZXMucmVzdWx0LnNzb0RvbWFpbjsNCiAgICAgICAgICBDb29raWVzLnNldCgiYWNjZXNzVG9rZW4iLCBhY2Nlc3NUb2tlbiwgew0KICAgICAgICAgICAgZG9tYWluOiBkb21haW4sDQogICAgICAgICAgICBleHBpcmVzOiA3LA0KICAgICAgICAgIH0pOw0KICAgICAgICB9DQogICAgICB9KTsNCiAgICAgIC8vIOiOt+WPlueUqOaIt+S/oeaBrw0KICAgICAgdXNlckluZm8oKS50aGVuKChyZXMpID0+IHsNCiAgICAgICAgaWYgKHJlcy5zdWNjZXNzKSB7DQogICAgICAgICAgLy8g6YG/5YWN6LaF6L+H5aSn5bCP6ZmQ5Yi2DQogICAgICAgICAgZGVsZXRlIHJlcy5yZXN1bHQucGVybWlzc2lvbnM7DQogICAgICAgICAgbGV0IHJvbGVzID0gW107DQogICAgICAgICAgcmVzLnJlc3VsdC5yb2xlcy5mb3JFYWNoKChlKSA9PiB7DQogICAgICAgICAgICByb2xlcy5wdXNoKGUubmFtZSk7DQogICAgICAgICAgfSk7DQogICAgICAgICAgZGVsZXRlIHJlcy5yZXN1bHQucm9sZXM7DQogICAgICAgICAgdGhpcy5zZXRTdG9yZSgicm9sZXMiLCByb2xlcyk7DQogICAgICAgICAgdGhpcy5zZXRTdG9yZSgic2F2ZUxvZ2luIiwgdGhpcy5zYXZlTG9naW4pOw0KICAgICAgICAgIGlmICh0aGlzLnNhdmVMb2dpbikgew0KICAgICAgICAgICAgLy8g5L+d5a2YN+WkqQ0KICAgICAgICAgICAgQ29va2llcy5zZXQoInVzZXJJbmZvIiwgSlNPTi5zdHJpbmdpZnkocmVzLnJlc3VsdCksIHsNCiAgICAgICAgICAgICAgZXhwaXJlczogNywNCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBDb29raWVzLnNldCgidXNlckluZm8iLCBKU09OLnN0cmluZ2lmeShyZXMucmVzdWx0KSk7DQogICAgICAgICAgfQ0KICAgICAgICAgIHRoaXMuc2V0U3RvcmUoInVzZXJJbmZvIiwgcmVzLnJlc3VsdCk7DQogICAgICAgICAgdGhpcy4kc3RvcmUuY29tbWl0KCJzZXRVc2VySW5mbyIsIHJlcy5yZXN1bHQpOw0KICAgICAgICAgIC8vIOWKoOi9veiPnOWNlQ0KICAgICAgICAgIHV0aWwuaW5pdFJvdXRlcih0aGlzKTsNCiAgICAgICAgICAvLyB3aW5kb3cubG9jYXRpb24ucmVsb2FkKCk7DQogICAgICAgICAgdGhpcy4kcm91dGVyLnB1c2goew0KICAgICAgICAgICAgbmFtZTogImhvbWVfaW5kZXgiLA0KICAgICAgICAgIH0pOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHRoaXMubG9hZGluZyA9IGZhbHNlOw0KICAgICAgICB9DQogICAgICB9KTsNCiAgICB9LA0KICAgIHN1Ym1pdExvZ2luKCkge30sDQogIH0sDQogIG1vdW50ZWQoKSB7DQogICAgdGhpcy5pbml0KCk7DQogIH0sDQogIGJlZm9yZURlc3Ryb3koKSB7DQogICAgaWYgKHRoaXMuY2hlY2tJbnRlcnZhbCkgew0KICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLmNoZWNrSW50ZXJ2YWwpOw0KICAgIH0NCiAgfSwNCn07DQo="},{"version":3,"sources":["login-qr.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAmEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"login-qr.vue","sourceRoot":"src/views","sourcesContent":["<template>\r\n  <div class=\"login\">\r\n    <Row type=\"flex\" justify=\"center\" align=\"middle\" style=\"height: 100%\">\r\n      <Col class=\"content\">\r\n        <div>\r\n          <Header />\r\n\r\n          <div style=\"position: relative\">\r\n            <Tabs>\r\n              <TabPane label=\"扫码登录\" name=\"qr\" icon=\"md-qr-scanner\">\r\n              </TabPane>\r\n            </Tabs>\r\n            <Tooltip\r\n              content=\"XBoot账号登录\"\r\n              placement=\"right\"\r\n              class=\"qr block-tool\"\r\n            >\r\n              <router-link to=\"/login\">\r\n                <XIcon type=\"iconfont icon-zhanghaodenglu\" size=\"30\" />\r\n              </router-link>\r\n            </Tooltip>\r\n          </div>\r\n          <div class=\"qr-content\">\r\n            <div class=\"code-content\">\r\n              <img :src=\"qrUrl\" class=\"qr-img\" />\r\n              <div\r\n                class=\"qr-status\"\r\n                v-show=\"qrStatus != '0' && qrStatus != '2'\"\r\n              >\r\n                <span v-show=\"qrStatus == '-2'\">二维码已失效</span>\r\n                <span v-show=\"qrStatus == '-1'\">您已取消此次登录</span>\r\n                <Icon\r\n                  type=\"md-checkmark-circle\"\r\n                  color=\"#19be6b\"\r\n                  size=\"34\"\r\n                  v-show=\"qrStatus == '1'\"\r\n                />\r\n                <span v-show=\"qrStatus == '1'\" class=\"success\">扫码成功</span>\r\n                <span v-show=\"qrStatus == '1'\">请在手机上确认登录</span>\r\n                <Button\r\n                  size=\"small\"\r\n                  type=\"primary\"\r\n                  class=\"refresh\"\r\n                  @click=\"getQRCode\"\r\n                  v-show=\"qrStatus != '1'\"\r\n                  >点击刷新</Button\r\n                >\r\n              </div>\r\n            </div>\r\n            <div class=\"qr-tip\">请使用 XBoot App 扫描二维码登录</div>\r\n          </div>\r\n\r\n          <Row type=\"flex\" justify=\"space-between\" class=\"other-login\">\r\n            <div class=\"other-way icons\"></div>\r\n            <router-link to=\"/register\">\r\n              <a class=\"forget-pass\">{{ $t(\"registerAccount\") }}</a>\r\n            </router-link>\r\n          </Row>\r\n        </div>\r\n        <Footer />\r\n      </Col>\r\n      <LangSwitch />\r\n    </Row>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport {\r\n  getLoginQRCode,\r\n  checkQRStatus,\r\n  userInfo,\r\n  getOtherSet,\r\n} from \"@/api/index\";\r\n\r\nimport Header from \"@/views/main-components/header\";\r\nimport Footer from \"@/views/main-components/footer\";\r\nimport LangSwitch from \"@/views/main-components/lang-switch\";\r\n\r\nimport util from \"@/libs/util.js\";\r\nimport QRCode from \"qrcode\";\r\nimport Cookies from 'js-cookie';\r\nexport default {\r\n  components: {\r\n    LangSwitch,\r\n    Header,\r\n    Footer,\r\n  },\r\n  data() {\r\n    return {\r\n      loading: false,\r\n      checkToken: \"\",\r\n      // 二维码状态 初始为0\r\n      qrStatus: \"0\",\r\n      qrUrl: \"\",\r\n      checkInterval: null,\r\n    };\r\n  },\r\n  methods: {\r\n    init() {\r\n      this.getQRCode();\r\n    },\r\n    getQRCode() {\r\n      getLoginQRCode().then((res) => {\r\n        if (res.success) {\r\n          this.qrStatus = \"0\";\r\n          let url = res.result;\r\n          this.generateQR(url);\r\n          this.checkToken = url.substring(url.indexOf(\"=\") + 1, url.length);\r\n          this.checkLoginQRStatus();\r\n        }\r\n      });\r\n    },\r\n    generateQR(v) {\r\n      QRCode.toDataURL(\r\n        v,\r\n        {\r\n          margin: 0,\r\n        },\r\n        (err, url) => {\r\n          if (err) {\r\n            this.$Message.error(\"生成二维码图片失败\");\r\n          }\r\n\r\n          this.qrUrl = url;\r\n        }\r\n      );\r\n    },\r\n    checkLoginQRStatus() {\r\n      // 3秒检测一次二维码状态\r\n      if (this.checkInterval) {\r\n        clearInterval(this.checkInterval);\r\n      }\r\n      this.checkInterval = setInterval(() => {\r\n        checkQRStatus(this.checkToken).then((res) => {\r\n          if (res.success) {\r\n            this.qrStatus = res.result.status;\r\n            if (this.qrStatus < \"0\") {\r\n              clearInterval(this.checkInterval);\r\n            }\r\n            if (this.qrStatus == \"2\") {\r\n              let accessToken = res.result.accessToken;\r\n              this.$Message.success(\"扫码登录成功\");\r\n              this.setStore(\"accessToken\", accessToken);\r\n              this.afterLogin(accessToken);\r\n            }\r\n          }\r\n        });\r\n      }, 3000);\r\n    },\r\n    afterLogin(accessToken) {\r\n      getOtherSet().then((res) => {\r\n        if (res.result) {\r\n          let domain = res.result.ssoDomain;\r\n          Cookies.set(\"accessToken\", accessToken, {\r\n            domain: domain,\r\n            expires: 7,\r\n          });\r\n        }\r\n      });\r\n      // 获取用户信息\r\n      userInfo().then((res) => {\r\n        if (res.success) {\r\n          // 避免超过大小限制\r\n          delete res.result.permissions;\r\n          let roles = [];\r\n          res.result.roles.forEach((e) => {\r\n            roles.push(e.name);\r\n          });\r\n          delete res.result.roles;\r\n          this.setStore(\"roles\", roles);\r\n          this.setStore(\"saveLogin\", this.saveLogin);\r\n          if (this.saveLogin) {\r\n            // 保存7天\r\n            Cookies.set(\"userInfo\", JSON.stringify(res.result), {\r\n              expires: 7,\r\n            });\r\n          } else {\r\n            Cookies.set(\"userInfo\", JSON.stringify(res.result));\r\n          }\r\n          this.setStore(\"userInfo\", res.result);\r\n          this.$store.commit(\"setUserInfo\", res.result);\r\n          // 加载菜单\r\n          util.initRouter(this);\r\n          // window.location.reload();\r\n          this.$router.push({\r\n            name: \"home_index\",\r\n          });\r\n        } else {\r\n          this.loading = false;\r\n        }\r\n      });\r\n    },\r\n    submitLogin() {},\r\n  },\r\n  mounted() {\r\n    this.init();\r\n  },\r\n  beforeDestroy() {\r\n    if (this.checkInterval) {\r\n      clearInterval(this.checkInterval);\r\n    }\r\n  },\r\n};\r\n</script>\r\n\r\n<style lang=\"less\">\r\n@import \"./login.less\";\r\n.qr-content {\r\n  height: 292px;\r\n  width: 100%;\r\n  display: flex;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  justify-content: center;\r\n  .code-content {\r\n    position: relative;\r\n    box-sizing: border-box;\r\n    width: 180px;\r\n    height: 180px;\r\n    padding: 7px;\r\n    margin: 0 auto;\r\n    background: #fff;\r\n    border: 1px solid #e5e5e5;\r\n    transition: transform 0.3s;\r\n    .qr-img {\r\n      width: 164px;\r\n      height: 164px;\r\n    }\r\n    .qr-status {\r\n      opacity: 1;\r\n      position: absolute;\r\n      display: flex;\r\n      flex-direction: column;\r\n      align-items: center;\r\n      justify-content: center;\r\n      width: 100%;\r\n      height: 100%;\r\n      left: 0;\r\n      top: 0;\r\n      background: hsla(0, 0%, 100%, 0.9);\r\n      font-size: 14px;\r\n      color: #323233;\r\n      font-weight: 500;\r\n      transition: opacity 0.3s;\r\n      .success {\r\n        color: #19be6b;\r\n        font-size: 16px;\r\n        margin: 5px 0;\r\n      }\r\n      .refresh {\r\n        margin-top: 15px;\r\n      }\r\n    }\r\n  }\r\n  .qr-tip {\r\n    margin-top: 30px;\r\n  }\r\n}\r\n</style>\r\n"]}]}