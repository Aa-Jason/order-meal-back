{"remainingRequest":"D:\\work\\workspace\\order\\xboot-plus-front\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\work\\workspace\\order\\xboot-plus-front\\src\\views\\login-qr.vue?vue&type=style&index=0&lang=less&","dependencies":[{"path":"D:\\work\\workspace\\order\\xboot-plus-front\\src\\views\\login-qr.vue","mtime":1651629755161},{"path":"D:\\work\\workspace\\order\\xboot-plus-front\\node_modules\\css-loader\\dist\\cjs.js","mtime":1651770028580},{"path":"D:\\work\\workspace\\order\\xboot-plus-front\\node_modules\\vue-loader\\lib\\loaders\\stylePostLoader.js","mtime":1651770027142},{"path":"D:\\work\\workspace\\order\\xboot-plus-front\\node_modules\\postcss-loader\\src\\index.js","mtime":1651770027415},{"path":"D:\\work\\workspace\\order\\xboot-plus-front\\node_modules\\less-loader\\dist\\cjs.js","mtime":1651770042155},{"path":"D:\\work\\workspace\\order\\xboot-plus-front\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1651770036753},{"path":"D:\\work\\workspace\\order\\xboot-plus-front\\node_modules\\vue-loader\\lib\\index.js","mtime":1651770027133}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:CgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCg0KQGltcG9ydCAiLi9sb2dpbi5sZXNzIjsNCi5xci1jb250ZW50IHsNCiAgaGVpZ2h0OiAyOTJweDsNCiAgd2lkdGg6IDEwMCU7DQogIGRpc3BsYXk6IGZsZXg7DQogIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47DQogIGFsaWduLWl0ZW1zOiBjZW50ZXI7DQogIGp1c3RpZnktY29udGVudDogY2VudGVyOw0KICAuY29kZS1jb250ZW50IHsNCiAgICBwb3NpdGlvbjogcmVsYXRpdmU7DQogICAgYm94LXNpemluZzogYm9yZGVyLWJveDsNCiAgICB3aWR0aDogMTgwcHg7DQogICAgaGVpZ2h0OiAxODBweDsNCiAgICBwYWRkaW5nOiA3cHg7DQogICAgbWFyZ2luOiAwIGF1dG87DQogICAgYmFja2dyb3VuZDogI2ZmZjsNCiAgICBib3JkZXI6IDFweCBzb2xpZCAjZTVlNWU1Ow0KICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjNzOw0KICAgIC5xci1pbWcgew0KICAgICAgd2lkdGg6IDE2NHB4Ow0KICAgICAgaGVpZ2h0OiAxNjRweDsNCiAgICB9DQogICAgLnFyLXN0YXR1cyB7DQogICAgICBvcGFjaXR5OiAxOw0KICAgICAgcG9zaXRpb246IGFic29sdXRlOw0KICAgICAgZGlzcGxheTogZmxleDsNCiAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47DQogICAgICBhbGlnbi1pdGVtczogY2VudGVyOw0KICAgICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7DQogICAgICB3aWR0aDogMTAwJTsNCiAgICAgIGhlaWdodDogMTAwJTsNCiAgICAgIGxlZnQ6IDA7DQogICAgICB0b3A6IDA7DQogICAgICBiYWNrZ3JvdW5kOiBoc2xhKDAsIDAlLCAxMDAlLCAwLjkpOw0KICAgICAgZm9udC1zaXplOiAxNHB4Ow0KICAgICAgY29sb3I6ICMzMjMyMzM7DQogICAgICBmb250LXdlaWdodDogNTAwOw0KICAgICAgdHJhbnNpdGlvbjogb3BhY2l0eSAwLjNzOw0KICAgICAgLnN1Y2Nlc3Mgew0KICAgICAgICBjb2xvcjogIzE5YmU2YjsNCiAgICAgICAgZm9udC1zaXplOiAxNnB4Ow0KICAgICAgICBtYXJnaW46IDVweCAwOw0KICAgICAgfQ0KICAgICAgLnJlZnJlc2ggew0KICAgICAgICBtYXJnaW4tdG9wOiAxNXB4Ow0KICAgICAgfQ0KICAgIH0NCiAgfQ0KICAucXItdGlwIHsNCiAgICBtYXJnaW4tdG9wOiAzMHB4Ow0KICB9DQp9DQo="},{"version":3,"sources":["login-qr.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA8MA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"login-qr.vue","sourceRoot":"src/views","sourcesContent":["<template>\r\n  <div class=\"login\">\r\n    <Row type=\"flex\" justify=\"center\" align=\"middle\" style=\"height: 100%\">\r\n      <Col class=\"content\">\r\n        <div>\r\n          <Header />\r\n\r\n          <div style=\"position: relative\">\r\n            <Tabs>\r\n              <TabPane label=\"扫码登录\" name=\"qr\" icon=\"md-qr-scanner\">\r\n              </TabPane>\r\n            </Tabs>\r\n            <Tooltip\r\n              content=\"XBoot账号登录\"\r\n              placement=\"right\"\r\n              class=\"qr block-tool\"\r\n            >\r\n              <router-link to=\"/login\">\r\n                <XIcon type=\"iconfont icon-zhanghaodenglu\" size=\"30\" />\r\n              </router-link>\r\n            </Tooltip>\r\n          </div>\r\n          <div class=\"qr-content\">\r\n            <div class=\"code-content\">\r\n              <img :src=\"qrUrl\" class=\"qr-img\" />\r\n              <div\r\n                class=\"qr-status\"\r\n                v-show=\"qrStatus != '0' && qrStatus != '2'\"\r\n              >\r\n                <span v-show=\"qrStatus == '-2'\">二维码已失效</span>\r\n                <span v-show=\"qrStatus == '-1'\">您已取消此次登录</span>\r\n                <Icon\r\n                  type=\"md-checkmark-circle\"\r\n                  color=\"#19be6b\"\r\n                  size=\"34\"\r\n                  v-show=\"qrStatus == '1'\"\r\n                />\r\n                <span v-show=\"qrStatus == '1'\" class=\"success\">扫码成功</span>\r\n                <span v-show=\"qrStatus == '1'\">请在手机上确认登录</span>\r\n                <Button\r\n                  size=\"small\"\r\n                  type=\"primary\"\r\n                  class=\"refresh\"\r\n                  @click=\"getQRCode\"\r\n                  v-show=\"qrStatus != '1'\"\r\n                  >点击刷新</Button\r\n                >\r\n              </div>\r\n            </div>\r\n            <div class=\"qr-tip\">请使用 XBoot App 扫描二维码登录</div>\r\n          </div>\r\n\r\n          <Row type=\"flex\" justify=\"space-between\" class=\"other-login\">\r\n            <div class=\"other-way icons\"></div>\r\n            <router-link to=\"/register\">\r\n              <a class=\"forget-pass\">{{ $t(\"registerAccount\") }}</a>\r\n            </router-link>\r\n          </Row>\r\n        </div>\r\n        <Footer />\r\n      </Col>\r\n      <LangSwitch />\r\n    </Row>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport {\r\n  getLoginQRCode,\r\n  checkQRStatus,\r\n  userInfo,\r\n  getOtherSet,\r\n} from \"@/api/index\";\r\n\r\nimport Header from \"@/views/main-components/header\";\r\nimport Footer from \"@/views/main-components/footer\";\r\nimport LangSwitch from \"@/views/main-components/lang-switch\";\r\n\r\nimport util from \"@/libs/util.js\";\r\nimport QRCode from \"qrcode\";\r\nimport Cookies from 'js-cookie';\r\nexport default {\r\n  components: {\r\n    LangSwitch,\r\n    Header,\r\n    Footer,\r\n  },\r\n  data() {\r\n    return {\r\n      loading: false,\r\n      checkToken: \"\",\r\n      // 二维码状态 初始为0\r\n      qrStatus: \"0\",\r\n      qrUrl: \"\",\r\n      checkInterval: null,\r\n    };\r\n  },\r\n  methods: {\r\n    init() {\r\n      this.getQRCode();\r\n    },\r\n    getQRCode() {\r\n      getLoginQRCode().then((res) => {\r\n        if (res.success) {\r\n          this.qrStatus = \"0\";\r\n          let url = res.result;\r\n          this.generateQR(url);\r\n          this.checkToken = url.substring(url.indexOf(\"=\") + 1, url.length);\r\n          this.checkLoginQRStatus();\r\n        }\r\n      });\r\n    },\r\n    generateQR(v) {\r\n      QRCode.toDataURL(\r\n        v,\r\n        {\r\n          margin: 0,\r\n        },\r\n        (err, url) => {\r\n          if (err) {\r\n            this.$Message.error(\"生成二维码图片失败\");\r\n          }\r\n\r\n          this.qrUrl = url;\r\n        }\r\n      );\r\n    },\r\n    checkLoginQRStatus() {\r\n      // 3秒检测一次二维码状态\r\n      if (this.checkInterval) {\r\n        clearInterval(this.checkInterval);\r\n      }\r\n      this.checkInterval = setInterval(() => {\r\n        checkQRStatus(this.checkToken).then((res) => {\r\n          if (res.success) {\r\n            this.qrStatus = res.result.status;\r\n            if (this.qrStatus < \"0\") {\r\n              clearInterval(this.checkInterval);\r\n            }\r\n            if (this.qrStatus == \"2\") {\r\n              let accessToken = res.result.accessToken;\r\n              this.$Message.success(\"扫码登录成功\");\r\n              this.setStore(\"accessToken\", accessToken);\r\n              this.afterLogin(accessToken);\r\n            }\r\n          }\r\n        });\r\n      }, 3000);\r\n    },\r\n    afterLogin(accessToken) {\r\n      getOtherSet().then((res) => {\r\n        if (res.result) {\r\n          let domain = res.result.ssoDomain;\r\n          Cookies.set(\"accessToken\", accessToken, {\r\n            domain: domain,\r\n            expires: 7,\r\n          });\r\n        }\r\n      });\r\n      // 获取用户信息\r\n      userInfo().then((res) => {\r\n        if (res.success) {\r\n          // 避免超过大小限制\r\n          delete res.result.permissions;\r\n          let roles = [];\r\n          res.result.roles.forEach((e) => {\r\n            roles.push(e.name);\r\n          });\r\n          delete res.result.roles;\r\n          this.setStore(\"roles\", roles);\r\n          this.setStore(\"saveLogin\", this.saveLogin);\r\n          if (this.saveLogin) {\r\n            // 保存7天\r\n            Cookies.set(\"userInfo\", JSON.stringify(res.result), {\r\n              expires: 7,\r\n            });\r\n          } else {\r\n            Cookies.set(\"userInfo\", JSON.stringify(res.result));\r\n          }\r\n          this.setStore(\"userInfo\", res.result);\r\n          this.$store.commit(\"setUserInfo\", res.result);\r\n          // 加载菜单\r\n          util.initRouter(this);\r\n          // window.location.reload();\r\n          this.$router.push({\r\n            name: \"home_index\",\r\n          });\r\n        } else {\r\n          this.loading = false;\r\n        }\r\n      });\r\n    },\r\n    submitLogin() {},\r\n  },\r\n  mounted() {\r\n    this.init();\r\n  },\r\n  beforeDestroy() {\r\n    if (this.checkInterval) {\r\n      clearInterval(this.checkInterval);\r\n    }\r\n  },\r\n};\r\n</script>\r\n\r\n<style lang=\"less\">\r\n@import \"./login.less\";\r\n.qr-content {\r\n  height: 292px;\r\n  width: 100%;\r\n  display: flex;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  justify-content: center;\r\n  .code-content {\r\n    position: relative;\r\n    box-sizing: border-box;\r\n    width: 180px;\r\n    height: 180px;\r\n    padding: 7px;\r\n    margin: 0 auto;\r\n    background: #fff;\r\n    border: 1px solid #e5e5e5;\r\n    transition: transform 0.3s;\r\n    .qr-img {\r\n      width: 164px;\r\n      height: 164px;\r\n    }\r\n    .qr-status {\r\n      opacity: 1;\r\n      position: absolute;\r\n      display: flex;\r\n      flex-direction: column;\r\n      align-items: center;\r\n      justify-content: center;\r\n      width: 100%;\r\n      height: 100%;\r\n      left: 0;\r\n      top: 0;\r\n      background: hsla(0, 0%, 100%, 0.9);\r\n      font-size: 14px;\r\n      color: #323233;\r\n      font-weight: 500;\r\n      transition: opacity 0.3s;\r\n      .success {\r\n        color: #19be6b;\r\n        font-size: 16px;\r\n        margin: 5px 0;\r\n      }\r\n      .refresh {\r\n        margin-top: 15px;\r\n      }\r\n    }\r\n  }\r\n  .qr-tip {\r\n    margin-top: 30px;\r\n  }\r\n}\r\n</style>\r\n"]}]}